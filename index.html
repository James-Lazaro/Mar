<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Para Ti Mar ‚ù§Ô∏è</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f1e6db;
      --text:#222;
      --muted:#444;
      --accent:#b3122b;
      --line:#000;
      --trunk:#8b4513;
      --cardR:26px;

      /* Pantalla 1 */
      --p1fg:#ffffff;
      --p1pink:#ffd6e7;
      --p1heart:#ff2b4f;
      --p1shadow: rgba(255, 43, 79, 0.6);
      --p1textGlow: 0 0 .6rem rgba(255, 214, 231, .9);
      --p1msgBg: rgba(139, 69, 119, 0.6);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#0b0b10;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding:16px;
    }

    .card{
      width:min(980px, 96vw);
      aspect-ratio: 16/9;
      background:var(--bg);
      border-radius:var(--cardR);
      position:relative;
      overflow:hidden;
      box-shadow:0 20px 80px rgba(0,0,0,.35);
    }

    .ground{
      position:absolute;
      left:0; right:0;
      bottom:9%;
      height:3px;
      background:var(--line);
      opacity:.85;
      z-index:1;
    }

    .back{
      position:absolute;
      top:14px; right:14px;
      z-index:50;
      border:none;
      background:rgba(255,255,255,.70);
      border:1px solid rgba(0,0,0,.12);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      display:none;
    }

    /* =========================
       PANTALLA 1 (Frases)
       ========================= */
    .screen1{
      position:absolute; inset:0;
      display:block;
      z-index:2;
    }

    .phraseScene{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      isolation:isolate;
      color:var(--p1fg);
      font-family: "Sour Gummy", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      user-select:none;
    }

    .phraseScene[data-bg="stars"]{
      background: linear-gradient(to bottom, #000000, #2a3a6b);
    }
    .phraseScene[data-bg="stars"]::before,
    .phraseScene[data-bg="stars"]::after{
      content:"";
      position:absolute; inset:-50% -50%;
      background-repeat:repeat;
      pointer-events:none;
      z-index:-1;
      will-change:opacity;
    }
    .phraseScene[data-bg="stars"]::before{
      background-image:
        radial-gradient(3px 3px at 15px 25px, #fff 50%, transparent 51%),
        radial-gradient(2px 2px at 45px 75px, #fff 50%, transparent 51%),
        radial-gradient(4px 4px at 85px 45px, #fff 50%, transparent 51%),
        radial-gradient(3px 3px at 125px 15px, #fff 50%, transparent 51%),
        radial-gradient(2px 2px at 165px 95px, #fff 50%, transparent 51%),
        radial-gradient(3px 3px at 205px 35px, #fff 50%, transparent 51%),
        radial-gradient(4px 4px at 245px 65px, #fff 50%, transparent 51%),
        radial-gradient(2px 2px at 285px 25px, #fff 50%, transparent 51%),
        radial-gradient(3px 3px at 325px 85px, #fff 50%, transparent 51%),
        radial-gradient(2px 2px at 365px 55px, #fff 50%, transparent 51%),
        radial-gradient(4px 4px at 405px 15px, #fff 50%, transparent 51%),
        radial-gradient(2px 2px at 445px 75px, #fff 50%, transparent 51%);
      background-size: 500px 400px;
      animation: twinkleA 4s ease-in-out infinite;
      opacity:1;
    }
    .phraseScene[data-bg="stars"]::after{
      background-image:
        radial-gradient(2px 2px at 30px 40px, #fff 50%, transparent 51%),
        radial-gradient(1px 1px at 70px 90px, #fff 50%, transparent 51%),
        radial-gradient(3px 3px at 110px 20px, #fff 50%, transparent 51%),
        radial-gradient(1px 1px at 150px 130px, #fff 50%, transparent 51%),
        radial-gradient(2px 2px at 190px 70px, #fff 50%, transparent 51%),
        radial-gradient(1px 1px at 230px 110px, #fff 50%, transparent 51%),
        radial-gradient(3px 3px at 270px 50px, #fff 50%, transparent 51%);
      background-size: 500px 350px;
      animation: twinkleB 6s ease-in-out infinite;
      opacity:0.85;
    }
    @keyframes twinkleA{
      0%{opacity:1} 25%{opacity:.3} 50%{opacity:.8} 75%{opacity:.2} 100%{opacity:1}
    }
    @keyframes twinkleB{
      0%{opacity:.85} 20%{opacity:.2} 40%{opacity:.9} 60%{opacity:.3} 80%{opacity:.7} 100%{opacity:.85}
    }

    .p1-heart-container{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      transform: translateY(-10px);
    }

    .p1-heart-btn{
      display:grid; place-items:center;
      width: clamp(240px, 34vmin, 420px);
      height: clamp(240px, 34vmin, 420px);
      border:none;
      background:transparent;
      cursor:pointer;
      filter: drop-shadow(0 0 40px rgba(255, 43, 79, .55));
      transition: transform .1s ease;
      z-index:2;
    }
    .p1-heart-btn:active{ transform: scale(.95); }

    .p1-heart{
      width: 85%;
      height: 85%;
      display:block;
      transform-origin:center;
      will-change: transform;
    }
    .p1-heart svg{ width:100%; height:100%; display:block; overflow:visible; }

    .p1-heart svg .core{
      fill: var(--p1heart);
      filter: drop-shadow(0 0 20px var(--p1shadow)) drop-shadow(0 0 40px rgba(255, 43, 79, .4));
      animation: gentleBeat 2.5s ease-in-out infinite;
      transform-origin: 50% 50%;
    }
    .p1-heart svg .shine{ fill: rgba(255,255,255,.35); mix-blend-mode: screen; }

    @keyframes gentleBeat{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.05); }
    }

    .p1-heart-btn.clicked .p1-heart svg .core{
      animation: strongBeat 0.7s cubic-bezier(0.17, 0.67, 0.83, 0.67), gentleBeat 2.5s ease-in-out infinite 0.7s;
    }
    @keyframes strongBeat{
      0%{ transform: scale(1); }
      15%{ transform: scale(1.8); }
      30%{ transform: scale(0.6); }
      45%{ transform: scale(1.6); }
      60%{ transform: scale(0.7); }
      75%{ transform: scale(1.3); }
      90%{ transform: scale(0.9); }
      100%{ transform: scale(1); }
    }

    .p1-phrase{
      position:absolute;
      display:inline-block;
      padding:.8em 1.4em;
      background: var(--p1msgBg);
      border-radius:25px;
      border:1px solid rgba(255,214,231,.3);
      font-weight:800;
      text-shadow: 0 2px 4px rgba(0,0,0,.6), var(--p1textGlow);
      pointer-events:none;
      font-size: clamp(14px, 2.2vw, 24px);
      color: var(--p1pink);
      opacity:0;
      z-index:10;
      box-shadow: 0 8px 32px rgba(255, 43, 79, .2);
      transform: translate(-50%, -50%);
      white-space: nowrap;
      will-change: transform, opacity;
    }
    .p1-phrase.shooting{
      animation: shootAndFall var(--duration, 6s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    @keyframes shootAndFall{
      0%{ opacity:0; transform: translate(-50%, -50%) scale(.5) rotate(var(--rotation, 0deg)); }
      10%{ opacity:1; transform: translate(calc(-50% + var(--shoot-x)), calc(-50% + var(--shoot-y))) scale(1.1) rotate(var(--rotation, 0deg)); }
      15%{ transform: translate(calc(-50% + var(--shoot-x)), calc(-50% + var(--shoot-y))) scale(1) rotate(var(--rotation, 0deg)); }
      90%{ opacity:1; transform: translate(calc(-50% + var(--final-x)), calc(-50% + var(--final-y))) scale(.85) rotate(var(--final-rotation, 0deg)); }
      100%{ opacity:0; transform: translate(calc(-50% + var(--final-x)), calc(-50% + var(--final-y))) scale(.7) rotate(var(--final-rotation, 0deg)); }
    }

    .p1-particle{
      position:absolute;
      width:4px;height:4px;
      background: var(--p1heart);
      border-radius:50%;
      pointer-events:none;
      z-index:1;
      opacity:0;
      will-change: transform, opacity;
    }
    .p1-particle.burst{
      animation: particleBurst 1s ease-out forwards;
    }
    @keyframes particleBurst{
      0%{ opacity:1; transform: scale(1.2); }
      100%{ opacity:0; transform: scale(0) translate(var(--particle-x, 0px), var(--particle-y, 0px)); }
    }

    .p1-music-player{
      position:absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%) translateY(-120%);
      background: var(--p1msgBg);
      padding: 10px 18px;
      border-radius: 20px;
      border: 1px solid rgba(255,214,231,.3);
      box-shadow: 0 8px 32px rgba(255, 43, 79, .2);
      display:flex;
      align-items:center;
      gap:12px;
      z-index:100;
      backdrop-filter: blur(10px);
      min-width: 260px;
      opacity:0;
      transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .p1-music-player.active{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }
    .p1-play-pause{
      background: rgba(255, 43, 79, 0.85);
      border:none;
      border-radius:50%;
      width:36px;height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:white;
      transition: all 0.25s ease;
      box-shadow: 0 4px 15px rgba(255, 43, 79, 0.3);
      flex:0 0 auto;
    }
    .p1-play-pause:hover{ transform: scale(1.06); }
    .p1-play-pause svg{ width:16px;height:16px; fill: currentColor; }

    .p1-progress-wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .p1-song-info{
      font-size:13px;
      color: var(--p1pink);
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      font-weight:700;
    }
    .p1-bar{
      width:100%;
      height:3px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      overflow:hidden;
      cursor:pointer;
    }
    .p1-fill{
      height:100%;
      background: linear-gradient(90deg, #ff2b4f, #ff5f7a);
      width:0%;
      transition: width 0.1s ease;
    }
    .p1-time{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      color: rgba(255, 214, 231, 0.85);
    }

    /* Hint juguet√≥n */
    .p1-hint{
      position:absolute;
      left:50%;
      top:72%;
      transform:translateX(-50%);
      z-index:130;
      padding:10px 16px;
      border-radius:999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,214,231,.25);
      color: var(--p1pink);
      font-weight:900;
      letter-spacing:.2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.45), var(--p1textGlow);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      font-size: clamp(13px, 2vw, 18px);
      animation: hintPulse 1.4s ease-in-out infinite;
    }
    @keyframes hintPulse{
      0%,100%{ transform:translateX(-50%) scale(1); opacity: .95; }
      50%{ transform:translateX(-50%) scale(1.06); opacity: 1; }
    }

    /* Continuar: oculto hasta primer click + delay */
    .p1-continue{
      position:absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index:120;
      border:none;
      cursor:pointer;
      padding: 12px 18px;
      border-radius: 999px;
      font-weight:900;
      background: rgba(255,255,255,0.92);
      color:#1a1a1a;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:none;
    }
    .p1-continue:active{ transform: translateX(-50%) scale(.98); }

    /* =========================
       PANTALLA 2 (√Årbol)
       ========================= */
    .screen2{
      position:absolute; inset:0;
      display:none;
      z-index:2;
    }
    .screen2 canvas{ width:100%; height:100%; display:block; }

    .letter{
      position:absolute;
      left:5%;
      top:14%;
      width:44%;
      color:#2b2b2b; /* ‚úÖ corregido (antes dec√≠a color:color:...) */
      line-height:1.55;
      font-size:18px;
      z-index:3;
    }
    .letter .title{
      margin:0 0 14px 0;
      font-size:20px;
      font-weight:400;
    }
    .letter p{ margin:10px 0; }
    .letter .sign{
      margin-top:12px;
      font-weight:800;
      font-family: "Segoe Script", "Brush Script MT", cursive; /* ‚úÖ firma con estilo */
      font-size:20px; /* ‚úÖ un poquito m√°s ‚Äúmanuscrito‚Äù */
      line-height:1.35;
    }

    .counter{
      position:absolute;
      left:5%;
      bottom:14%;
      color:var(--text);
      font-size:18px;
      z-index:3;
    }
    .counter .muted{ color:var(--muted); display:block; margin-bottom:4px; }

    .photo{
      position:absolute;
      right:6%;
      top:14%;
      width:170px;
      max-width:220px;
      background:#fff;
      padding:8px;
      border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,.25);
      z-index:4;
      transform: rotate(2deg);
    }
    .photo img{
      width:100%;
      height:auto;
      display:block;
      border-radius:12px;
    }
/* ====== MODO VERTICAL (CELULAR EN PORTRAIT) ====== */
@media (max-aspect-ratio: 1/1) {
  body { padding: 0; }

  .card{
    width: 100vw;
    height: 100vh;
    aspect-ratio: auto;     /* quita el 16:9 */
    border-radius: 0;       /* para que se vea full pantalla */
  }

  /* Pantalla 2: reacomodar texto/√°rbol para vertical */
  .letter{
    left: 6%;
    top: 8%;
    width: 88%;
    font-size: 16px;
  }

  .photo{
    right: 6%;
    top: 42%;
    width: 130px;           /* foto m√°s peque√±a */
  }

  .counter{
    left: 6%;
    bottom: 10%;
    font-size: 16px;
  }

  .ground{
    bottom: 8%;
  }
}

    
  </style>
</head>

<body>
  <div class="card">
    <div class="ground"></div>

    <!-- Pantalla 1 -->
    <div class="screen1" id="screen1">
      <div class="phraseScene" id="scene" data-bg="stars">
        <div class="p1-heart-container">
          <button class="p1-heart-btn" id="heartBtn" aria-label="Mar, presiona mi coraz√≥n xD">
            <span class="p1-heart">
              <svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <radialGradient id="g" cx="50%" cy="40%" r="70%">
                    <stop offset="0%" stop-color="#ff5f7a" />
                    <stop offset="40%" stop-color="#ff2b4f" />
                    <stop offset="100%" stop-color="#c91534" />
                  </radialGradient>
                </defs>
                <path class="core"
                  d="M100,162.2C17.7,99.5,6,77.5,6,52.3C6,27.1,27.1,6,52.3,6c15.4,0,30.8,7.7,40,20.6l7.7,9.6l7.7-9.6
                  c9.2-12.9,24.6-20.6,40-20.6c25.2,0,46.3,21.1,46.3,46.3c0,25.2-11.7,47.2-94,109.9L100,162.2z"
                  fill="url(#g)"/>
                <path class="shine"
                  d="M73 47c-12 0-23 6-29 16-2 3-1 7 2 9 3 2 7 1 9-2 4-7 12-11 20-11 4 0 7-3 7-7s-3-5-9-5Z"/>
              </svg>
            </span>
          </button>
        </div>

        <div class="p1-hint" id="hintText">¬°Mar, p√≠came el coraz√≥n! üòú‚ù§Ô∏è</div>

        <div class="p1-music-player" id="musicPlayer">
          <button class="p1-play-pause" id="playPauseBtn" aria-label="Play/Pause">
            <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
          </button>
          <div class="p1-progress-wrap">
            <div class="p1-song-info">Te dedico esta canci√≥n ‚ù§Ô∏è</div>
            <div class="p1-bar" id="progressBar"><div class="p1-fill" id="progressFill"></div></div>
            <div class="p1-time">
              <span id="currentTime">0:00</span>
              <span id="totalTime">0:00</span>
            </div>
          </div>
        </div>

        <button class="p1-continue" id="continueBtn">Mar, contin√∫a ‚ù§Ô∏è</button>
      </div>

      <audio id="audioPlayer" loop>
        <source src="https://www.dropbox.com/scl/fi/v8dbihkx7pj30lmjt2kxk/SHE-LOOKS-LIKE-A-DREAM.mp3?rlkey=q951cxdk40i49tsr95d7l5s3e&dl=1" type="audio/mpeg">
      </audio>
    </div>

    <!-- Bot√≥n volver (pantalla 2) -->
    <button class="back" id="backBtn">‚üµ</button>

    <!-- Pantalla 2 -->
    <div class="screen2" id="screen2">
      <canvas id="cv"></canvas>

      <div class="letter">
        <h3 class="title">Para mi amor, Mar:</h3>
        <p>Si pudiera elegir el mejor lugar, ser√≠a a tu lado.</p>
        <p>Cuanto m√°s tiempo estoy contigo, m√°s te quiero.</p>
        <p class="sign">‚Äî Feliz San Valent√≠n!<br>‚Äî Atentamente<br>‚Äî James ;) </p>
      </div>

      <div class="photo">
        <img src="JamesYMar.jpeg" alt="Juntos!">
      </div>

      <div class="counter">
        <span class="muted">Mi amor por ti comenz√≥ hace‚Ä¶</span>
        <span id="counterText">0 d√≠as 0 horas 00 minutos 00 segundos</span>
      </div>
    </div>
  </div>

<script>
  const START_DATE = new Date("2025-12-25T22:00:00");

  const PHRASES = [
    "Todo lo que te digo es verdad! ‚ú® ", "Contigo todo es cool üåô ",
    "Y tu quien eres? No te conozco xD", "Esos ojos que me gustan tanto! üåü ",
    "Eres mi canci√≥n infinita üé∂ ", "Mi destino eres t√∫ üí´ ",
    "Vamos a hacer el amor y no la guerra üî• ", "Holaaa xD",
    "Te quiero cada d√≠a m√°s üíñ", "Mu√±eca preciosa üòè ",
    "Beso en el cuello üíñ", "Vamos a besarnos üòú"
  ];

  /* =========================
     PANTALLAS
     ========================= */
  const screen1 = document.getElementById("screen1");
  const screen2 = document.getElementById("screen2");
  const backBtn  = document.getElementById("backBtn");
  const continueBtn = document.getElementById("continueBtn");
  const hintText = document.getElementById("hintText");

  continueBtn.addEventListener("click", () => {
    screen1.style.display = "none";
    screen2.style.display = "block";
    backBtn.style.display = "block";
    startTree();
  });

  backBtn.addEventListener("click", () => {
    stopTree();
    screen2.style.display = "none";
    backBtn.style.display = "none";
    screen1.style.display = "block";
  });

  /* =========================
     PANTALLA 1: FRASES + M√öSICA
     ========================= */
  const scene = document.getElementById('scene');
  const heartBtn = document.getElementById('heartBtn');
  const musicPlayer = document.getElementById('musicPlayer');
  const audioPlayer = document.getElementById('audioPlayer');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const currentTimeEl = document.getElementById('currentTime');
  const totalTimeEl = document.getElementById('totalTime');
  const playIcon = document.getElementById('playIcon');
  const pauseIcon = document.getElementById('pauseIcon');

  let isProcessing = false;
  let firstClick = true;
  let isPlaying = false;
  let continueUnlocked = false;

  function showPlayIcon(){ playIcon.style.display="block"; pauseIcon.style.display="none"; }
  function showPauseIcon(){ playIcon.style.display="none"; pauseIcon.style.display="block"; }

  function activateMusic(){
    musicPlayer.classList.add('active');
    audioPlayer.play().then(() => {
      isPlaying = true;
      showPauseIcon();
    }).catch(()=>{});
  }

  function togglePlayPause(){
    if (isPlaying){
      audioPlayer.pause();
      isPlaying = false;
      showPlayIcon();
    } else {
      audioPlayer.play().then(() => {
        isPlaying = true;
        showPauseIcon();
      }).catch(()=>{});
    }
  }

  function formatTime(seconds){
    const mins = Math.floor(seconds/60);
    const secs = Math.floor(seconds%60);
    return mins + ":" + (secs < 10 ? "0" : "") + secs;
  }

  function updateProgress(){
    if (!audioPlayer.duration) return;
    const p = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressFill.style.width = p + "%";
    currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
    totalTimeEl.textContent = formatTime(audioPlayer.duration);
  }

  function seekAudio(e){
    if (!audioPlayer.duration) return;
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    audioPlayer.currentTime = (clickX / rect.width) * audioPlayer.duration;
  }

  function rand(min,max){ return Math.random()*(max-min)+min; }

  function createParticlesBurst(){
    const heartRect = heartBtn.getBoundingClientRect();
    const sceneRect = scene.getBoundingClientRect();
    const cx = heartRect.left + heartRect.width/2 - sceneRect.left;
    const cy = heartRect.top  + heartRect.height/2 - sceneRect.top;

    const count = Math.floor(rand(10, 15));
    for (let i=0;i<count;i++){
      const p = document.createElement("div");
      p.className = "p1-particle burst";
      p.style.left = cx + "px";
      p.style.top  = cy + "px";

      const ang = Math.random()*360;
      const dist = rand(50, 90);
      const x = Math.cos(ang*Math.PI/180)*dist;
      const y = Math.sin(ang*Math.PI/180)*dist;

      p.style.setProperty("--particle-x", x + "px");
      p.style.setProperty("--particle-y", y + "px");

      scene.appendChild(p);
      p.addEventListener("animationend", () => p.remove(), {once:true});
    }
  }

  function createPhrase(){
    const phraseText = PHRASES[Math.floor(Math.random()*PHRASES.length)];
    const el = document.createElement("div");
    el.className = "p1-phrase shooting";
    el.textContent = phraseText;

    const heartRect = heartBtn.getBoundingClientRect();
    const sceneRect = scene.getBoundingClientRect();
    const startX = heartRect.left + heartRect.width/2 - sceneRect.left;
    const startY = heartRect.top  + heartRect.height/2 - sceneRect.top;

    el.style.left = startX + "px";
    el.style.top  = startY + "px";

    const angle = Math.random()*120 - 150;
    const shootForce = rand(150, 230);
    const shootX = Math.cos(angle*Math.PI/180) * shootForce;
    const shootY = Math.sin(angle*Math.PI/180) * shootForce;

    const fallDistance = rand(250, 450);
    const horizontalDrift = rand(-120, 120);
    const finalX = shootX + horizontalDrift;
    const finalY = shootY + fallDistance;

    const initialRotation = rand(-20, 20);
    const finalRotation = initialRotation + rand(-40, 40);
    const duration = rand(4.5, 6.5);

    el.style.setProperty("--shoot-x", shootX + "px");
    el.style.setProperty("--shoot-y", shootY + "px");
    el.style.setProperty("--final-x", finalX + "px");
    el.style.setProperty("--final-y", finalY + "px");
    el.style.setProperty("--rotation", initialRotation + "deg");
    el.style.setProperty("--final-rotation", finalRotation + "deg");
    el.style.setProperty("--duration", duration + "s");

    scene.appendChild(el);
    el.addEventListener("animationend", () => el.remove(), {once:true});
  }

  function releasePhrase(){
    heartBtn.classList.add("clicked");
    setTimeout(()=>heartBtn.classList.remove("clicked"), 700);
    createParticlesBurst();
    createPhrase();
  }

  function triggerRelease(e){
    e.preventDefault();
    if (isProcessing) return;
    isProcessing = true;

    if (firstClick){
      activateMusic();
      firstClick = false;

      if (hintText){
        hintText.textContent = "¬°Eso! Presiona m√°s, hay m√°s frases üòè";
        setTimeout(()=>{ hintText.style.opacity = "0"; }, 2500);
        setTimeout(()=>{ hintText.style.display = "none"; }, 3200);
      }

      if (!continueUnlocked){
        continueUnlocked = true;
        setTimeout(() => {
          continueBtn.style.display = "inline-block";
          continueBtn.animate(
            [
              { transform: "translateX(-50%) translateY(10px)", opacity: 0 },
              { transform: "translateX(-50%) translateY(0px)", opacity: 1 }
            ],
            { duration: 420, easing: "cubic-bezier(0.2, 0.8, 0.2, 1)", fill: "forwards" }
          );
        }, 3000);
      }
    }

    releasePhrase();
    setTimeout(()=>{ isProcessing = false; }, 250);
  }

  heartBtn.addEventListener("click", triggerRelease);
  playPauseBtn.addEventListener("click", togglePlayPause);
  progressBar.addEventListener("click", seekAudio);
  audioPlayer.addEventListener("timeupdate", updateProgress);
  audioPlayer.addEventListener("loadedmetadata", updateProgress);

  /* =========================
     PANTALLA 2: CONTADOR + √ÅRBOL
     ========================= */
  const counterEl = document.getElementById("counterText");
  let counterTimer = null;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function updateCounter(){
    const now = new Date();
    const diff = Math.max(0, now - START_DATE);
    const sec = Math.floor(diff/1000);
    const days = Math.floor(sec/86400);
    const hours = Math.floor((sec%86400)/3600);
    const mins = Math.floor((sec%3600)/60);
    const secs = sec % 60;
    counterEl.textContent = `${days} d√≠as ${hours} horas ${pad2(mins)} minutos ${pad2(secs)} segundos`;
  }

  const canvas = document.getElementById("cv");
  const ctx = canvas.getContext("2d");

  let raf=null;
  let leaves=[];
  let fallers=[];
  let W=0,H=0;

  function resizeCanvas(){
    const r = canvas.getBoundingClientRect();
    W = r.width; H = r.height;
    canvas.width  = Math.floor(W * devicePixelRatio);
    canvas.height = Math.floor(H * devicePixelRatio);
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }

  window.addEventListener("resize", () => {
    if (!raf) return;
    resizeCanvas();
    buildCrown();
  });

  function randColor(){
    const palette = ["#b3122b","#d11f3a","#ff4d6d","#ff758f","#c9184a","#a4133c"];
    return palette[(Math.random()*palette.length)|0];
  }

  function insideHeart(x, y){
    const f = Math.pow(x*x + y*y - 1, 3) - (x*x)*(y*y*y);
    return f <= 0;
  }

  function buildCrown(){
    leaves = [];

    const trunkX  = W * 0.74;
    const crownCX = trunkX;
    const crownCY = H * 0.34;

    const scale = Math.min(W,H) * 0.30;
    const N = 1100;

    let tries = 0;
    while (leaves.length < N && tries < N*60){
      tries++;

      const x = (Math.random()*2.6 - 1.3);
      const y = (Math.random()*2.6 - 1.3);

      const x2 = x * 1.0;
      const y2 = y * 1.18;

      if (insideHeart(x2, y2)){
        leaves.push({
          x: crownCX + x * scale + (Math.random()*2-1),
          y: crownCY - y * scale + (Math.random()*2-1),
          s: 6 + Math.random()*8,
          r: Math.random()*Math.PI,
          c: randColor(),
          w: 0.2 + Math.random()*0.8
        });
      }
    }
  }

  function drawHeart(x,y,size,rot,color,alpha=1){
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.translate(x,y);
    ctx.rotate(rot);
    ctx.scale(size/20, size/20);
    ctx.fillStyle = color;

    ctx.beginPath();
    ctx.moveTo(0, 7);
    ctx.bezierCurveTo(0, 0, -12, 0, -12, 7);
    ctx.bezierCurveTo(-12, 14, -4, 18, 0, 22);
    ctx.bezierCurveTo(4, 18, 12, 14, 12, 7);
    ctx.bezierCurveTo(12, 0, 0, 0, 0, 7);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function drawTrunk(){
    const baseX = W*0.74;
    const baseY = H*0.91;

    ctx.save();
    ctx.strokeStyle = "#8b4513";
    ctx.lineCap = "round";

    ctx.lineWidth = 18;
    ctx.beginPath();
    ctx.moveTo(baseX, baseY);
    ctx.quadraticCurveTo(baseX-10, baseY-85, baseX-6, baseY-165);
    ctx.quadraticCurveTo(baseX-2, baseY-225, baseX+2, baseY-270);
    ctx.stroke();

    ctx.lineWidth = 12;
    ctx.beginPath();
    ctx.moveTo(baseX-2, baseY-190);
    ctx.quadraticCurveTo(baseX+34, baseY-220, baseX+48, baseY-260);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(baseX-10, baseY-210);
    ctx.quadraticCurveTo(baseX-40, baseY-250, baseX-58, baseY-295);
    ctx.stroke();

    ctx.lineWidth = 10;
    ctx.beginPath();
    ctx.moveTo(baseX-2, baseY-250);
    ctx.quadraticCurveTo(baseX+16, baseY-285, baseX+18, baseY-322);
    ctx.stroke();

    ctx.restore();
  }

  function spawnFaller(){
    if (Math.random() > 0.50) return;
    const origin = leaves[(Math.random()*leaves.length)|0];

    fallers.push({
      x: origin.x + (Math.random()*14-7),
      y: origin.y + (Math.random()*10-5),
      vx: (Math.random()*0.9-0.45),
      vy: 1.1 + Math.random()*1.3,
      g: 0.02 + Math.random()*0.03,
      s: 5 + Math.random()*6,
      r: Math.random()*Math.PI,
      vr:(Math.random()*0.06-0.03),
      c: randColor(),
      life: 260 + Math.random()*160
    });

    if (fallers.length > 180) fallers.splice(0, fallers.length-180);
  }

  function stepTree(){
    for (const p of leaves) p.r += 0.002 * p.w;

    spawnFaller();
    for (const f of fallers){
      f.vy += f.g;
      f.x += f.vx;
      f.y += f.vy;
      f.r += f.vr;
      f.life -= 1;
    }
    fallers = fallers.filter(f => f.life>0 && f.y < H*0.95);
  }

  function renderTree(){
    ctx.clearRect(0,0,W,H);

    /* ‚úÖ SOMBRA suave debajo del √°rbol (antes del tronco) */
    ctx.save();
    ctx.fillStyle = "rgba(180, 0, 40, 0.12)";
    ctx.beginPath();
    ctx.ellipse(W*0.74, H*0.90, 120, 20, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    drawTrunk();

    for (const p of leaves){
      drawHeart(p.x, p.y, p.s, p.r, p.c, 1);
    }
    for (const f of fallers){
      const a = Math.min(1, f.life/220);
      drawHeart(f.x, f.y, f.s, f.r, f.c, a);
    }
  }

  function loopTree(){
    stepTree();
    renderTree();
    raf = requestAnimationFrame(loopTree);
  }

  function startTree(){
    resizeCanvas();
    buildCrown();
    fallers = [];

    if (counterTimer) clearInterval(counterTimer);
    updateCounter();
    counterTimer = setInterval(updateCounter, 1000);

    loopTree();
  }

  function stopTree(){
    if (raf) cancelAnimationFrame(raf);
    raf = null;
    if (counterTimer) clearInterval(counterTimer);
    counterTimer = null;
  }
</script>
</body>
</html>
